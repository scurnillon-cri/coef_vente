<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Calculateur de Coefficient de Vente - CRI</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: #eef1f5;
        font-family: "Inter", system-ui, sans-serif;
      }

      /* HEADER */
      .cri-header {
        background: white;
        border-radius: 14px;
        box-shadow: 0 4px 18px rgba(0, 0, 0, 0.09);
      }

      .cri-logo {
        max-height: 80px;
      }

      /* TOOLBAR */
      .toolbar {
        background: white;
        border-radius: 14px;
        padding: 14px;
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
      }

      /* GRID AVANT / APRES */
      .compare-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      @media (max-width: 450px) {
        .compare-grid {
          grid-template-columns: 1fr 1fr; /* reste c√¥te √† c√¥te m√™me sur mobile */
        }
      }

      .compare-card {
        background: #f7f8fa;
        border-radius: 14px;
        overflow: hidden;
        padding-bottom: 10px;
      }

      .sticky-header {
        padding: 10px;
        font-weight: 700;
        text-align: center;
        font-size: 1.1rem;
      }

      .header-avant {
        background: #c7cdd4;
        color: black;
      }

      .header-apres {
        background: #0a2345; /* Bleu CRI */
        color: white;
      }

      label {
        font-size: 12px !important;
        margin-bottom: 2px !important;
      }

      /* Champs compacts + anti-zoom iPhone */
      input.form-control {
        font-size: 16px !important;
        padding: 4px 6px !important;
        height: 34px !important;
        border-radius: 6px;
      }

      .input-group {
        align-items: center;
      }

      .auto-btn {
        font-size: 20px;
        padding: 3px 10px;
        border: 1px solid #ccc;
        background: white;
        border-radius: 6px;
        cursor: pointer;
      }

      .auto-btn:hover {
        background: #e5e5e5;
      }

      /* R√©sultat */
      .card {
        border-radius: 14px;
        border: none;
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
      }

      .progress {
        height: 16px;
        border-radius: 20px;
      }
    </style>
  </head>

  <body class="p-3">
    <div class="container">
      <!-- HEADER -->
      <div
        class="cri-header d-flex flex-column flex-md-row align-items-center justify-content-between px-4 py-3 mb-4"
      >
        <img src="logo_cri.png" class="cri-logo" alt="CRI" />
        <h1 class="mt-3 mt-md-0 text-center text-md-end">
          Calculateur de Coefficient de Vente
        </h1>
      </div>

      <!-- TOOLBAR -->
      <div
        class="toolbar d-flex flex-column flex-md-row justify-content-between gap-3 mb-4"
      >
        <div class="flex-grow-1">
          <label class="fw-bold mb-1">Nom de la configuration :</label>
          <input type="text" id="configName" class="form-control" />
        </div>

        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-primary" onclick="saveConfiguration()">
            üíæ Sauvegarder
          </button>
          <select id="configList" class="form-select">
            <option value="">‚Äî Configurations ‚Äî</option>
          </select>
          <button class="btn btn-success" onclick="loadConfiguration()">
            üìÇ Charger
          </button>
          <button class="btn btn-danger" onclick="deleteConfiguration()">
            üóë Supprimer
          </button>
        </div>
      </div>

      <!-- PRIX PUBLIC -->
      <div class="card mb-4">
        <div class="card-header bg-dark text-white">Prix Public</div>
        <div class="card-body">
          <input
            type="number"
            id="prixPublic"
            class="form-control"
            value="500"
            oninput="updateAll()"
          />
        </div>
      </div>

      <!-- AVANT / APRES -->
      <div class="compare-grid">
        <!-- AVANT -->
        <div class="compare-card">
          <div class="sticky-header header-avant">Avant</div>

          <div class="px-3">
            <label>Remise (%)</label>
            <input
              type="number"
              id="remiseAvant"
              class="form-control"
              oninput="updateAll()"
            />

            <label class="mt-2">Prix achat (‚Ç¨)</label>
            <input
              type="number"
              id="achatAvant"
              class="form-control"
              readonly
            />

            <label class="mt-2">Coef de vente</label>
            <input
              type="number"
              id="coefAvant"
              step="0.01"
              class="form-control"
              oninput="updateFromCoef('Avant')"
            />

            <label class="mt-2">Prix vente (‚Ç¨)</label>
            <input
              type="number"
              id="venteAvant"
              class="form-control"
              oninput="updateFromVente('Avant')"
            />

            <label class="mt-2">Marge (‚Ç¨)</label>
            <input
              type="number"
              id="margeAvant"
              class="form-control"
              oninput="updateFromMarge('Avant')"
            />
          </div>
        </div>

        <!-- APRES -->
        <div class="compare-card">
          <div class="sticky-header header-apres">Apr√®s</div>

          <div class="px-3">
            <label>Remise (%)</label>
            <input
              type="number"
              id="remiseApres"
              class="form-control"
              oninput="updateAll()"
            />

            <label class="mt-2">Prix achat (‚Ç¨)</label>
            <input
              type="number"
              id="achatApres"
              class="form-control"
              readonly
            />

            <label class="mt-2">Coef de vente</label>
            <div class="input-group">
              <input
                type="number"
                id="coefApres"
                step="0.01"
                class="form-control"
                oninput="updateFromCoef('Apres')"
              />
              <!-- Bouton qui ouvre la popup de strat√©gie -->
              <span
                class="auto-btn"
                data-bs-toggle="modal"
                data-bs-target="#strategieModal"
                title="Choisir une strat√©gie de calcul"
              >
                üîÑ
              </span>
            </div>

            <label class="mt-2">Prix vente (‚Ç¨)</label>
            <input
              type="number"
              id="venteApres"
              class="form-control"
              oninput="updateFromVente('Apres')"
            />

            <label class="mt-2">Marge (‚Ç¨)</label>
            <input
              type="number"
              id="margeApres"
              class="form-control"
              oninput="updateFromMarge('Apres')"
            />
          </div>
        </div>
      </div>

      <!-- RESULTAT -->
      <div class="card mt-4">
        <div class="card-header bg-info text-white">
          R√©sultat de Comp√©titivit√©
        </div>
        <div class="card-body">
          <p id="competitiviteTexte" class="text-center fs-5 fw-semibold"></p>
          <div class="progress">
            <div
              id="competitiviteBarre"
              class="progress-bar"
              style="width: 0%"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODALE STRAT√âGIE -->
    <div
      class="modal fade"
      id="strategieModal"
      tabindex="-1"
      aria-labelledby="strategieModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="strategieModalLabel">
              Choisir une strat√©gie
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Fermer"
            ></button>
          </div>
          <div class="modal-body">
            <p>
              Comment souhaitez-vous utiliser le gain li√© √† la nouvelle remise
              fournisseur&nbsp;?
            </p>

            <div class="mb-3">
              <button
                type="button"
                class="btn btn-outline-danger w-100 mb-1"
                onclick="strategieOffensive()"
                data-bs-dismiss="modal"
              >
                Strat√©gie offensive
              </button>
              <small class="text-muted">
                M√™me marge qu'avant, mais prix de vente plus agressif.
              </small>
            </div>

            <div class="mb-1">
              <button
                type="button"
                class="btn btn-outline-primary w-100 mb-1"
                onclick="strategieEquilibre()"
                data-bs-dismiss="modal"
              >
                Strat√©gie √©quilibre
              </button>
              <small class="text-muted">
                Gain r√©parti : moiti√© en marge en plus, moiti√© en baisse de
                prix.
              </small>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Fermer
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      /* ---------- CALCULS BASIQUES ---------- */

      function updateFromCoef(side) {
        const achat = parseFloat(document.getElementById("achat" + side).value);
        const coef = parseFloat(document.getElementById("coef" + side).value);

        if (isNaN(achat) || isNaN(coef) || achat <= 0) return;

        const vente = achat * coef;
        const marge = vente - achat;

        document.getElementById("vente" + side).value = vente.toFixed(2);
        document.getElementById("marge" + side).value = marge.toFixed(2);

        updateAll();
      }

      function updateFromVente(side) {
        const achat = parseFloat(document.getElementById("achat" + side).value);
        const vente = parseFloat(document.getElementById("vente" + side).value);

        if (isNaN(achat) || isNaN(vente) || achat <= 0) return;

        const coef = vente / achat;
        const marge = vente - achat;

        document.getElementById("coef" + side).value = coef.toFixed(2);
        document.getElementById("marge" + side).value = marge.toFixed(2);

        updateAll();
      }

      function updateFromMarge(side) {
        const achat = parseFloat(document.getElementById("achat" + side).value);
        const marge = parseFloat(document.getElementById("marge" + side).value);

        if (isNaN(achat) || isNaN(marge) || achat <= 0) return;

        const vente = achat + marge;
        const coef = vente / achat;

        document.getElementById("vente" + side).value = vente.toFixed(2);
        document.getElementById("coef" + side).value = coef.toFixed(2);

        updateAll();
      }

      /* ---------- STRATEGIES ---------- */

      // 1) Strat√©gie offensive : m√™me marge, prix agressif
      function strategieOffensive() {
        const achatA = parseFloat(achatAvant.value);
        const venteA = parseFloat(venteAvant.value);
        const achatB = parseFloat(achatApres.value);

        if ([achatA, venteA, achatB].some((v) => isNaN(v) || v <= 0)) return;

        const margeA = venteA - achatA;

        const venteB = achatB + margeA;
        const coefB = venteB / achatB;

        coefApres.value = coefB.toFixed(2);
        venteApres.value = venteB.toFixed(2);
        margeApres.value = margeA.toFixed(2);

        updateAll();
      }

      // 2) Strat√©gie √©quilibre : 50% gain en marge, 50% en baisse de prix
      function strategieEquilibre() {
        const achatA = parseFloat(achatAvant.value);
        const venteA = parseFloat(venteAvant.value);
        const achatB = parseFloat(achatApres.value);

        if ([achatA, venteA, achatB].some((v) => isNaN(v) || v <= 0)) return;

        const margeA = venteA - achatA;
        const margeMax = venteA - achatB; // marge possible si on garde le m√™me prix
        const gainTotal = margeMax - margeA;

        if (gainTotal <= 0) {
          // Pas de gain, on retombe sur offensive
          strategieOffensive();
          return;
        }

        const margeB = margeA + gainTotal / 2; // moiti√© du gain en marge
        const venteB = achatB + margeB; // reste en baisse de prix
        const coefB = venteB / achatB;

        coefApres.value = coefB.toFixed(2);
        venteApres.value = venteB.toFixed(2);
        margeApres.value = margeB.toFixed(2);

        updateAll();
      }

      /* ---------- MISE A JOUR GLOBALE ---------- */

      function updateAll() {
        const prix = parseFloat(prixPublic.value);

        if (!isNaN(prix)) {
          achatAvant.value = (
            prix *
            (1 - parseFloat(remiseAvant.value || 0) / 100)
          ).toFixed(2);
          achatApres.value = (
            prix *
            (1 - parseFloat(remiseApres.value || 0) / 100)
          ).toFixed(2);
        }

        updateCompetitivite();
      }

      /* ---------- MESSAGE COMMERCIAL ---------- */

      function updateCompetitivite() {
        const vA = parseFloat(venteAvant.value);
        const vB = parseFloat(venteApres.value);
        const mA = parseFloat(margeAvant.value);
        const mB = parseFloat(margeApres.value);

        const txt = document.getElementById("competitiviteTexte");
        const bar = document.getElementById("competitiviteBarre");

        if ([vA, vB, mA, mB].some((v) => isNaN(v) || v === 0)) {
          txt.innerHTML = "";
          bar.style.width = "0%";
          bar.className = "progress-bar";
          return;
        }

        const varPrix = (vB / vA - 1) * 100;
        const varMarge = (mB / mA - 1) * 100;

        let msg = "",
          color = "";

        if (Math.abs(varMarge) < 0.01 && varPrix < 0) {
          msg =
            "üü¢ Strat√©gie offensive : m√™me marge, prix plus bas de <b>" +
            Math.abs(varPrix).toFixed(2) +
            "%</b>. Vous devenez plus comp√©titif.";
          color = "bg-success";
        } else if (varMarge > 0 && varPrix < 0) {
          msg =
            "üåü Strat√©gie √©quilibre : marge +<b>" +
            Math.abs(varMarge).toFixed(2) +
            "%</b> et prix -<b>" +
            Math.abs(varPrix).toFixed(2) +
            "%</b>. Plus rentable ET plus comp√©titif.";
          color = "bg-success";
        } else if (varMarge > 0 && varPrix > 0) {
          msg =
            "‚öñÔ∏è Marge +<b>" +
            Math.abs(varMarge).toFixed(2) +
            "%</b>, mais prix +<b>" +
            Math.abs(varPrix).toFixed(2) +
            "%</b>. Rentable mais moins comp√©titif.";
          color = "bg-warning";
        } else {
          msg =
            "üîµ Prix plus attractif, marge en retrait : levier strat√©gique √† manier avec pr√©caution.";
          color = "bg-primary";
        }

        txt.innerHTML = msg;
        bar.className = "progress-bar " + color;
        bar.style.width = Math.min(Math.abs(varMarge - varPrix), 100) + "%";
      }

      /* ---------- SAUVEGARDES ---------- */

      function getAllConfigs() {
        return JSON.parse(localStorage.getItem("coefConfigs") || "{}");
      }

      function updateConfigList() {
        const configs = getAllConfigs();
        configList.innerHTML = `<option value="">‚Äî Configurations ‚Äî</option>`;
        for (const name in configs) {
          configList.innerHTML += `<option value="${name}">${name}</option>`;
        }
      }

      function saveConfiguration() {
        const name = configName.value.trim();
        if (!name) return alert("Nom obligatoire.");

        const configs = getAllConfigs();

        configs[name] = {
          prix: prixPublic.value,
          remiseAvant: remiseAvant.value,
          coefAvant: coefAvant.value,
          remiseApres: remiseApres.value,
          coefApres: coefApres.value,
        };

        localStorage.setItem("coefConfigs", JSON.stringify(configs));
        updateConfigList();
        alert("Configuration sauvegard√©e ‚úî");
      }

      function loadConfiguration() {
        const name = configList.value;
        if (!name) return;

        const cfg = getAllConfigs()[name];

        prixPublic.value = cfg.prix;
        remiseAvant.value = cfg.remiseAvant;
        coefAvant.value = cfg.coefAvant;
        remiseApres.value = cfg.remiseApres;
        coefApres.value = cfg.coefApres;

        updateAll();
      }

      function deleteConfiguration() {
        const name = configList.value;
        if (!name) return;

        const configs = getAllConfigs();

        delete configs[name];
        localStorage.setItem("coefConfigs", JSON.stringify(configs));

        updateConfigList();
      }

      /* INIT */
      updateConfigList();
      updateAll();
    </script>
  </body>
</html>
