<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calculateur de Coefficient de Vente - CRI</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: #f5f7fa;
        font-family: "Inter", system-ui, sans-serif;
      }

      .card {
        border-radius: 14px;
        border: none;
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.08);
      }

      .cri-header {
        background: white;
        border-radius: 14px;
        box-shadow: 0 4px 18px rgba(0, 0, 0, 0.08);
      }

      .cri-logo {
        max-height: 80px;
      }

      .toolbar {
        background: white;
        border-radius: 14px;
        padding: 14px;
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
      }

      /* --- MODE COMPARATIF PREMIUM --- */
      .compare-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      .compare-card {
        border-radius: 12px;
        padding: 0;
        margin: 0;
      }

      .sticky-header {
        position: sticky;
        top: 0;
        z-index: 20;
        padding: 8px;
        font-size: 1.1rem;
        font-weight: 700;
        color: white;
        text-align: center;
      }

      /* Labels et inputs plus compacts pour mobile */
      @media (max-width: 768px) {
        label {
          font-size: 0.78rem;
        }
        input.form-control {
          font-size: 0.85rem;
          padding: 6px 8px;
        }
      }

      .progress {
        height: 18px;
        border-radius: 20px;
      }

      #competitiviteTexte {
        font-size: 1.25rem;
        font-weight: 600;
      }
    </style>
  </head>

  <body class="p-3">
    <div class="container">
      <!-- HEADER -->
      <div
        class="cri-header d-flex flex-column flex-md-row align-items-center justify-content-between px-4 py-3 mb-4"
      >
        <img src="logo_cri.png" class="cri-logo" />
        <h1 class="mt-3 mt-md-0 text-center text-md-end">
          Calculateur de Coefficient de Vente
        </h1>
      </div>

      <!-- TOOLBAR -->
      <div
        class="toolbar d-flex flex-column flex-md-row justify-content-between gap-3 mb-4"
      >
        <div class="flex-grow-1">
          <label class="form-label fw-bold mb-1"
            >Nom de la configuration :</label
          >
          <input type="text" id="configName" class="form-control" />
        </div>

        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-primary" onclick="saveConfiguration()">
            üíæ Sauvegarder
          </button>
          <select id="configList" class="form-select">
            <option value="">‚Äî Configurations ‚Äî</option>
          </select>
          <button class="btn btn-success" onclick="loadConfiguration()">
            üìÇ Charger
          </button>
          <button class="btn btn-danger" onclick="deleteConfiguration()">
            üóë Supprimer
          </button>
        </div>
      </div>

      <!-- PRIX PUBLIC -->
      <div class="card mb-4">
        <div class="card-header bg-dark text-white">Prix Public</div>
        <div class="card-body">
          <input
            type="number"
            id="prixPublic"
            class="form-control"
            value="500"
            oninput="updateAll()"
          />
        </div>
      </div>

      <!-- ‚ö° GRID AVANT / APR√àS c√¥te √† c√¥te m√™me sur mobile -->
      <div class="compare-grid">
        <!-- AVANT -->
        <div class="compare-card">
          <div class="sticky-header bg-primary">Avant</div>
          <div class="p-3">
            <label class="form-label">Remise (%)</label>
            <input
              type="number"
              id="remiseAvant"
              class="form-control"
              oninput="updateAll()"
            />

            <label class="form-label mt-3">Prix d'achat (‚Ç¨)</label>
            <input
              type="number"
              id="achatAvant"
              class="form-control"
              readonly
            />

            <label class="form-label mt-3">Coef de vente</label>
            <input
              type="number"
              id="coefAvant"
              step="0.01"
              class="form-control"
              oninput="updateFromCoef('Avant')"
            />

            <label class="form-label mt-3">Prix de vente (‚Ç¨)</label>
            <input
              type="number"
              id="venteAvant"
              class="form-control"
              oninput="updateFromVente('Avant')"
            />

            <label class="form-label mt-3">Marge (‚Ç¨)</label>
            <input
              type="number"
              id="margeAvant"
              class="form-control"
              oninput="updateFromMarge('Avant')"
            />
          </div>
        </div>

        <!-- APR√àS -->
        <div class="compare-card">
          <div class="sticky-header bg-success">Apr√®s</div>
          <div class="p-3">
            <label class="form-label">Nouvelle Remise (%)</label>
            <input
              type="number"
              id="remiseApres"
              class="form-control"
              oninput="updateAll()"
            />

            <label class="form-label mt-3">Nouveau Prix d'achat (‚Ç¨)</label>
            <input
              type="number"
              id="achatApres"
              class="form-control"
              readonly
            />

            <label class="form-label mt-3">Nouveau Coef de vente</label>
            <div class="input-group">
              <input
                type="number"
                id="coefApres"
                step="0.01"
                class="form-control"
                oninput="updateFromCoef('Apres')"
              />
              <button
                class="btn btn-outline-primary"
                onclick="calcCoefEqualGain()"
              >
                = Gain Avant
              </button>
            </div>

            <label class="form-label mt-3">Nouveau Prix de vente (‚Ç¨)</label>
            <input
              type="number"
              id="venteApres"
              class="form-control"
              oninput="updateFromVente('Apres')"
            />

            <label class="form-label mt-3">Nouvelle Marge (‚Ç¨)</label>
            <input
              type="number"
              id="margeApres"
              class="form-control"
              oninput="updateFromMarge('Apres')"
            />

            <label class="form-label mt-3">Gain (%)</label>
            <input
              type="number"
              id="gainPourcent"
              class="form-control"
              readonly
            />
          </div>
        </div>
      </div>

      <!-- MESSAGE COMMERCIAL -->
      <div class="card mt-4">
        <div class="card-header bg-info text-white">
          R√©sultat de Comp√©titivit√©
        </div>
        <div class="card-body">
          <p id="competitiviteTexte" class="text-center"></p>

          <div class="progress">
            <div
              id="competitiviteBarre"
              class="progress-bar bg-secondary"
              style="width: 0%"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <!-- SCRIPT -->
    <script>
      /* ---------------------------------------------------
   üîÑ SYNC COEF ‚Üî VENTE ‚Üî MARGE
--------------------------------------------------- */

      function updateFromCoef(side) {
        const achat = parseFloat(document.getElementById("achat" + side).value);
        const coef = parseFloat(document.getElementById("coef" + side).value);

        const vente = achat * coef;
        const marge = vente - achat;

        document.getElementById("vente" + side).value = vente.toFixed(2);
        document.getElementById("marge" + side).value = marge.toFixed(2);

        updateAll();
      }

      function updateFromVente(side) {
        const achat = parseFloat(document.getElementById("achat" + side).value);
        const vente = parseFloat(document.getElementById("vente" + side).value);

        const coef = vente / achat;
        const marge = vente - achat;

        document.getElementById("coef" + side).value = coef.toFixed(2);
        document.getElementById("marge" + side).value = marge.toFixed(2);

        updateAll();
      }

      function updateFromMarge(side) {
        const achat = parseFloat(document.getElementById("achat" + side).value);
        const marge = parseFloat(document.getElementById("marge" + side).value);

        const vente = achat + marge;
        const coef = vente / achat;

        document.getElementById("vente" + side).value = vente.toFixed(2);
        document.getElementById("coef" + side).value = coef.toFixed(2);

        updateAll();
      }

      /* ---------------------------------------------------
   üéØ BOUTON = GAIN AVANT
--------------------------------------------------- */

      function calcCoefEqualGain() {
        const achatA = parseFloat(achatAvant.value);
        const venteA = parseFloat(venteAvant.value);
        const margeA = venteA - achatA;

        const achatB = parseFloat(achatApres.value);

        const venteExact = achatB + margeA;
        const coefExact = venteExact / achatB;

        coefApres.value = coefExact.toFixed(2);
        venteApres.value = venteExact.toFixed(2);
        margeApres.value = margeA.toFixed(2);

        updateAll();
      }

      /* ---------------------------------------------------
   üîÑ CALCUL GLOBAL
--------------------------------------------------- */

      function updateAll() {
        const prix = parseFloat(prixPublic.value);

        achatAvant.value = (prix * (1 - remiseAvant.value / 100)).toFixed(2);
        achatApres.value = (prix * (1 - remiseApres.value / 100)).toFixed(2);

        updateGain();
        updateCompetitivite();
      }

      /* ---------------------------------------------------
   üìâ GAIN %
--------------------------------------------------- */

      function updateGain() {
        const vA = parseFloat(venteAvant.value);
        const vB = parseFloat(venteApres.value);
        gainPourcent.value = ((vB / vA - 1) * 100).toFixed(2);
      }

      /* ---------------------------------------------------
   üì¢ MESSAGE COMMERCIAL PREMIUM
--------------------------------------------------- */

      function updateCompetitivite() {
        const vA = parseFloat(venteAvant.value);
        const vB = parseFloat(venteApres.value);
        const mA = parseFloat(margeAvant.value);
        const mB = parseFloat(margeApres.value);

        const txt = document.getElementById("competitiviteTexte");
        const bar = document.getElementById("competitiviteBarre");

        if (!vA || !vB || !mA) return;

        const varPrix = (vB / vA - 1) * 100;
        const varMarge = (mB / mA - 1) * 100;

        let msg = "",
          color = "";

        if (Math.abs(varMarge) < 0.01 && varPrix < 0) {
          msg =
            "üü¢ M√™me marge, prix plus bas de <b>" +
            Math.abs(varPrix).toFixed(2) +
            "%</b>. Plus comp√©titif.";
          color = "bg-success";
        } else if (Math.abs(varMarge) < 0.01 && varPrix > 0) {
          msg =
            "üü† M√™me marge mais prix +<b>" +
            Math.abs(varPrix).toFixed(2) +
            "%</b>. Attention.";
          color = "bg-warning";
        } else if (varMarge > 0 && varPrix < 0) {
          msg =
            "üåü Marge +<b>" +
            Math.abs(varMarge).toFixed(2) +
            "%</b> et prix -<b>" +
            Math.abs(varPrix).toFixed(2) +
            "%</b>. Sc√©nario id√©al.";
          color = "bg-success";
        } else if (varMarge > 0 && varPrix > 0) {
          msg =
            "‚öñÔ∏è Marge +<b>" +
            Math.abs(varMarge).toFixed(2) +
            "%</b>, prix +<b>" +
            Math.abs(varPrix).toFixed(2) +
            "%</b>. Rentable mais moins comp√©titif.";
          color = "bg-info";
        } else {
          msg =
            "üîµ Prix attractif mais marge en retrait : strat√©gie √† manier avec pr√©cision.";
          color = "bg-primary";
        }

        txt.innerHTML = msg;

        bar.className = "progress-bar " + color;
        bar.style.width = Math.min(Math.abs(varMarge - varPrix), 100) + "%";
      }

      /* ---------------------------------------------------
   üíæ SAUVEGARDE CONFIGS
--------------------------------------------------- */

      function getAllConfigs() {
        return JSON.parse(localStorage.getItem("coefConfigs") || "{}");
      }

      function updateConfigList() {
        const configs = getAllConfigs();
        configList.innerHTML = `<option value="">‚Äî Configurations ‚Äî</option>`;
        for (const name in configs) {
          configList.innerHTML += `<option value="${name}">${name}</option>`;
        }
      }

      function saveConfiguration() {
        const name = configName.value.trim();
        if (!name) return alert("Nom obligatoire.");

        const configs = getAllConfigs();

        configs[name] = {
          prix: prixPublic.value,
          remiseAvant: remiseAvant.value,
          coefAvant: coefAvant.value,
          remiseApres: remiseApres.value,
          coefApres: coefApres.value,
        };

        localStorage.setItem("coefConfigs", JSON.stringify(configs));
        updateConfigList();
        alert("Configuration sauvegard√©e ‚úî");
      }

      function loadConfiguration() {
        const name = configList.value;
        if (!name) return;

        const cfg = getAllConfigs()[name];

        prixPublic.value = cfg.prix;
        remiseAvant.value = cfg.remiseAvant;
        coefAvant.value = cfg.coefAvant;
        remiseApres.value = cfg.remiseApres;
        coefApres.value = cfg.coefApres;

        updateAll();
      }

      function deleteConfiguration() {
        const name = configList.value;
        if (!name) return;

        const configs = getAllConfigs();

        delete configs[name];
        localStorage.setItem("coefConfigs", JSON.stringify(configs));

        updateConfigList();
      }

      /* INIT */
      updateConfigList();
      updateAll();
    </script>
  </body>
</html>
