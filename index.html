<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Calculateur de Coefficient de Vente - CRI</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: #eef1f5;
        font-family: "Inter", system-ui, sans-serif;
      }

      .cri-header {
        background: white;
        border-radius: 14px;
        box-shadow: 0 4px 18px rgba(0, 0, 0, 0.09);
      }

      .cri-logo {
        max-height: 80px;
      }

      .toolbar {
        background: white;
        border-radius: 14px;
        padding: 14px;
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
      }

      .compare-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      @media (max-width: 450px) {
        .compare-grid {
          grid-template-columns: 1fr 1fr;
        }
      }

      .compare-card {
        background: #f7f8fa;
        border-radius: 14px;
        overflow: hidden;
        padding-bottom: 10px;
      }

      .sticky-header {
        padding: 10px;
        font-weight: 700;
        text-align: center;
        font-size: 1.1rem;
      }

      .header-avant {
        background: #c7cdd4;
        color: black;
      }

      .header-apres {
        background: #0a2345; /* bleu CRI */
        color: white;
      }

      label {
        font-size: 12px !important;
        margin-bottom: 2px !important;
      }

      input.form-control {
        font-size: 16px !important; /* √©vite le zoom iPhone */
        padding: 4px 6px !important;
        height: 34px !important;
        border-radius: 6px;
      }

      .auto-btn {
        font-size: 20px;
        padding: 3px 10px;
        border: 1px solid #ccc;
        background: white;
        border-radius: 6px;
        cursor: pointer;
      }

      .auto-btn:hover {
        background: #e5e5e5;
      }

      .card {
        border-radius: 14px;
        border: none;
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
      }
    </style>
  </head>

  <body class="p-3">
    <div class="container">
      <!-- HEADER -->
      <div
        class="cri-header d-flex flex-column flex-md-row align-items-center justify-content-between px-4 py-3 mb-4"
      >
        <img src="logo_cri.png" class="cri-logo" alt="CRI" />
        <h1 class="mt-3 mt-md-0 text-center text-md-end">
          Calculateur de Coefficient de Vente
        </h1>
      </div>

      <!-- TOOLBAR -->
      <div
        class="toolbar d-flex flex-column flex-md-row justify-content-between gap-3 mb-4"
      >
        <div class="flex-grow-1">
          <label class="fw-bold mb-1">Nom de la configuration :</label>
          <input type="text" id="configName" class="form-control" />
        </div>

        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-primary" onclick="saveConfiguration()">
            üíæ Sauvegarder
          </button>
          <select id="configList" class="form-select">
            <option value="">‚Äî Configurations ‚Äî</option>
          </select>
          <button class="btn btn-success" onclick="loadConfiguration()">
            üìÇ Charger
          </button>
          <button class="btn btn-danger" onclick="deleteConfiguration()">
            üóë Supprimer
          </button>
        </div>
      </div>

      <!-- PRIX PUBLIC -->
      <div class="card mb-4">
        <div class="card-header bg-dark text-white">Prix Public</div>
        <div class="card-body">
          <input
            type="text"
            inputmode="decimal"
            pattern="[0-9]*"
            id="prixPublic"
            class="form-control"
            value="500"
            oninput="updateAll(); updateCompetitivite();"
          />
        </div>
      </div>

      <!-- AVANT / AVEC LE C.R.I. -->
      <div class="compare-grid">
        <!-- AVANT -->
        <div class="compare-card">
          <div class="sticky-header header-avant">Avant</div>

          <div class="px-3">
            <label>Remise (%)</label>
            <input
              type="text"
              inputmode="decimal"
              pattern="[0-9]*"
              id="remiseAvant"
              class="form-control"
              oninput="updateAll(); updateCompetitivite();"
            />

            <label class="mt-2">Prix achat (‚Ç¨)</label>
            <input
              type="text"
              inputmode="decimal"
              pattern="[0-9]*"
              id="achatAvant"
              class="form-control"
              readonly
            />

            <label class="mt-2">Coef de vente</label>
            <input
              type="text"
              inputmode="decimal"
              pattern="[0-9]*"
              id="coefAvant"
              class="form-control"
              oninput="updateFromCoef('Avant');"
            />

            <label class="mt-2">Prix vente (‚Ç¨)</label>
            <input
              type="text"
              inputmode="decimal"
              pattern="[0-9]*"
              id="venteAvant"
              class="form-control"
              oninput="updateFromVente('Avant');"
            />

            <label class="mt-2">Marge (‚Ç¨)</label>
            <input
              type="text"
              inputmode="decimal"
              pattern="[0-9]*"
              id="margeAvant"
              class="form-control"
              oninput="updateFromMarge('Avant');"
            />
          </div>
        </div>

        <!-- AVEC LE C.R.I. -->
        <div class="compare-card">
          <div class="sticky-header header-apres">Avec le C.R.I.</div>

          <div class="px-3">
            <label>Remise (%)</label>
            <input
              type="text"
              inputmode="decimal"
              pattern="[0-9]*"
              id="remiseApres"
              class="form-control"
              oninput="updateAll(); updateCompetitivite();"
            />

            <label class="mt-2">Prix achat (‚Ç¨)</label>
            <input
              type="text"
              inputmode="decimal"
              pattern="[0-9]*"
              id="achatApres"
              class="form-control"
              readonly
            />

            <label class="mt-2">Coef de vente</label>
            <div class="input-group">
              <input
                type="text"
                inputmode="decimal"
                pattern="[0-9]*"
                id="coefApres"
                class="form-control"
                oninput="updateFromCoef('Apres');"
              />

              <span
                class="auto-btn"
                data-bs-toggle="modal"
                data-bs-target="#strategieModal"
                title="Choisir une strat√©gie de calcul"
              >
                üîÑ
              </span>
            </div>

            <label class="mt-2">Prix vente (‚Ç¨)</label>
            <input
              type="text"
              inputmode="decimal"
              pattern="[0-9]*"
              id="venteApres"
              class="form-control"
              oninput="updateFromVente('Apres');"
            />

            <label class="mt-2">Marge (‚Ç¨)</label>
            <input
              type="text"
              inputmode="decimal"
              pattern="[0-9]*"
              id="margeApres"
              class="form-control"
              oninput="updateFromMarge('Apres');"
            />
          </div>
        </div>
      </div>

      <!-- RESULTAT DE COMPETITIVITE -->
      <div class="card mt-4">
        <div class="card-header bg-info text-white">
          R√©sultat de Comp√©titivit√©
        </div>
        <div class="card-body">
          <p id="competitiviteTexte" class="text-center fs-5 fw-semibold"></p>
        </div>
      </div>
    </div>

    <!-- MODALE STRAT√âGIES -->
    <div
      class="modal fade"
      id="strategieModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Choisissez votre strat√©gie</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Fermer"
            ></button>
          </div>

          <div class="modal-body fs-5">
            <!-- STRAT√âGIE OFFENSIVE = ZONE 1 -->
            <div class="mb-4 p-3 border rounded">
              <button
                type="button"
                class="btn btn-danger w-100 fw-bold mb-2"
                onclick="strategieOffensive();"
                data-bs-dismiss="modal"
              >
                üöÄ Strat√©gie OFFENSIVE ‚Äì Zone 1
              </button>

              <div class="text-center fw-semibold">
                Marge = &nbsp;&nbsp;|&nbsp;&nbsp; Prix de vente ‚Üì‚Üì
              </div>

              <small class="text-muted d-block text-center mt-1">
                Prix tr√®s agressif, marge en baisse : id√©al pour faire du
                volume, mais avec un risque accru d‚Äôaffaires peu rentables.
              </small>
            </div>

            <!-- STRAT√âGIE √âQUILIBR√âE = ZONE 2 -->
            <div class="mb-4 p-3 border rounded">
              <button
                type="button"
                class="btn btn-success w-100 fw-bold mb-2"
                onclick="strategieEquilibree();"
                data-bs-dismiss="modal"
              >
                ‚úÖ Strat√©gie √âQUILIBR√âE ‚Äì Zone 2
              </button>

              <div class="text-center fw-semibold">
                Marge = &nbsp;&nbsp;|&nbsp;&nbsp; Prix comp√©titif
              </div>

              <small class="text-muted d-block text-center mt-1">
                Marge maintenue et prix comp√©titif : vous augmentez votre CA et
                vous f√©d√©rez vos commerciaux. C‚Äôest la configuration id√©ale.
              </small>
            </div>

            <!-- STRAT√âGIE DEFENSIVE = ZONE 3 -->
            <div class="mb-2 p-3 border rounded">
              <button
                type="button"
                class="btn btn-danger w-100 fw-bold mb-2"
                onclick="strategieDefensive();"
                data-bs-dismiss="modal"
              >
                üõ°Ô∏è Strat√©gie DEFENSIVE ‚Äì Zone 3
              </button>

              <div class="text-center fw-semibold">
                Marge ‚Üë &nbsp;&nbsp;|&nbsp;&nbsp; Prix de vente =
              </div>

              <small class="text-muted d-block text-center mt-1">
                Prix identique et marge plus forte, mais les ventes restent
                difficiles : vos taux de transformation risquent de stagner.
              </small>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              Fermer
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      /* ---- Helpers ---- */

      function getNumber(id) {
        const el = document.getElementById(id);
        if (!el) return NaN;
        const raw = (el.value || "").replace(",", ".");
        const v = parseFloat(raw);
        return isNaN(v) ? NaN : v;
      }

      function setNumber(id, value) {
        const el = document.getElementById(id);
        if (!el || isNaN(value)) return;
        el.value = value.toFixed(2);
      }

      /* ---- Calculs basiques ---- */

      function updateFromCoef(side) {
        const achat = getNumber("achat" + side);
        const coef = getNumber("coef" + side);
        if (isNaN(achat) || isNaN(coef) || achat <= 0) return;

        const vente = achat * coef;
        const marge = vente - achat;

        setNumber("vente" + side, vente);
        setNumber("marge" + side, marge);

        updateAll();
        updateCompetitivite();
      }

      function updateFromVente(side) {
        const achat = getNumber("achat" + side);
        const vente = getNumber("vente" + side);
        if (isNaN(achat) || isNaN(vente) || achat <= 0) return;

        const coef = vente / achat;
        const marge = vente - achat;

        setNumber("coef" + side, coef);
        setNumber("marge" + side, marge);

        updateAll();
        updateCompetitivite();
      }

      function updateFromMarge(side) {
        const achat = getNumber("achat" + side);
        const marge = getNumber("marge" + side);
        if (isNaN(achat) || isNaN(marge) || achat <= 0) return;

        const vente = achat + marge;
        const coef = vente / achat;

        setNumber("vente" + side, vente);
        setNumber("coef" + side, coef);

        updateAll();
        updateCompetitivite();
      }

      /* ---- Strat√©gies ---- */

      // ZONE 1 : coef = coefAvant
      function strategieOffensive() {
        const coefA = getNumber("coefAvant");
        const achatB = getNumber("achatApres");
        if (isNaN(coefA) || isNaN(achatB) || achatB <= 0) return;

        const venteB = achatB * coefA;
        const margeB = venteB - achatB;

        setNumber("coefApres", coefA);
        setNumber("venteApres", venteB);
        setNumber("margeApres", margeB);

        updateAll();
        updateCompetitivite();
      }

      // ZONE 2 : m√™me marge en valeur
      function strategieEquilibree() {
        const achatA = getNumber("achatAvant");
        const venteA = getNumber("venteAvant");
        const achatB = getNumber("achatApres");

        if ([achatA, venteA, achatB].some((v) => isNaN(v) || v <= 0)) return;

        const margeA = venteA - achatA;
        const venteB = achatB + margeA;
        const coefB = venteB / achatB;

        setNumber("coefApres", coefB);
        setNumber("venteApres", venteB);
        setNumber("margeApres", margeA);

        updateAll();
        updateCompetitivite();
      }

      // ZONE 3 : m√™me prix de vente
      function strategieDefensive() {
        const venteA = getNumber("venteAvant");
        const achatB = getNumber("achatApres");
        if (isNaN(venteA) || isNaN(achatB) || achatB <= 0) return;

        const coefB = venteA / achatB;
        const venteB = venteA;
        const margeB = venteB - achatB;

        setNumber("coefApres", coefB);
        setNumber("venteApres", venteB);
        setNumber("margeApres", margeB);

        updateAll();
        updateCompetitivite();
      }

      /* ---- Mise √† jour globale ---- */

      function updateAll() {
        const prix = getNumber("prixPublic");

        if (!isNaN(prix)) {
          const remiseA = getNumber("remiseAvant") || 0;
          const remiseB = getNumber("remiseApres") || 0;

          const achatA = prix * (1 - remiseA / 100);
          const achatB = prix * (1 - remiseB / 100);

          setNumber("achatAvant", achatA);
          setNumber("achatApres", achatB);
        }
      }

      /* ---- R√©sultat de comp√©titivit√© (zones) ---- */

      function updateCompetitivite() {
        const vA = getNumber("venteAvant");
        const vB = getNumber("venteApres");
        const mA = getNumber("margeAvant");
        const mB = getNumber("margeApres");
        const coefA = getNumber("coefAvant");
        const coefB = getNumber("coefApres");
        const achatB = getNumber("achatApres");

        const txt = document.getElementById("competitiviteTexte");

        if (
          [vA, vB, mA, mB, coefA, coefB, achatB].some(
            (v) => isNaN(v) || v === 0
          )
        ) {
          txt.innerHTML = "";
          return;
        }

        const margeA = mA;
        const margeB = mB;

        // calcul bornes
        const coefMin = coefA; // Zone 1 : m√™me coef qu'avant
        const coefMid = (achatB + margeA) / achatB; // Zone 2 : m√™me marge en valeur
        const coefMax = vA / achatB; // Zone 3 : m√™me prix de vente

        if (coefMid < coefMin || coefMax < coefMid) {
          txt.innerHTML =
            "‚ö†Ô∏è Param√®tres incoh√©rents, v√©rifiez vos valeurs Avant.";
          return;
        }

        const tol = 0.01; // tol√©rance pour comparer les coefs

        let msg = "";

        if (coefB < coefMin - tol || coefB > coefMax + tol) {
          msg =
            "‚ö†Ô∏è Le coefficient choisi sort des limites logiques : en-dessous, la marge devient trop faible ; au-dessus, le prix n‚Äôest plus cr√©dible pour le march√©. Ajustez votre coef entre la zone 1 et la zone 3.";
        } else if (Math.abs(coefB - coefMin) <= tol) {
          // Zone 1 exacte
          msg =
            "üü• Zone 1 ‚Äì Strat√©gie OFFENSIVE : votre prix de vente est le plus agressif mais votre marge diminue fortement. Vous devez compenser par du volume. Les commerciaux sont ravis‚Ä¶ mais le risque d‚Äôaffaires peu rentables augmente.";
        } else if (coefB > coefMin && coefB < coefMid - tol) {
          // Zone 1.5
          msg =
            "üü¶ Zone 1+ : votre prix reste tr√®s comp√©titif mais votre marge baisse. Vous √™tes encore dans une logique de volume, avec un risque ma√Ætris√© par rapport √† une strat√©gie totalement offensive.";
        } else if (Math.abs(coefB - coefMid) <= tol) {
          // Zone 2 exacte
          msg =
            "üü© Zone 2 ‚Äì Strat√©gie √âQUILIBR√âE : votre marge est maintenue et votre prix reste comp√©titif. Vous augmentez votre chiffre d‚Äôaffaires et vous f√©d√©rez vos commerciaux. C‚Äôest la configuration id√©ale.";
        } else if (coefB > coefMid + tol && coefB < coefMax - tol) {
          // Zone 2.5
          msg =
            "üüß Zone 2+ : votre marge progresse mais votre prix devient moins attractif. Vos commerciaux devront argumenter davantage pour conclure leurs ventes.";
        } else if (Math.abs(coefB - coefMax) <= tol) {
          // Zone 3 exacte
          msg =
            "üü• Zone 3 ‚Äì Strat√©gie DEFENSIVE : votre prix de vente reste inchang√© et votre marge augmente fortement. Mais vos taux de transformation risquent de rester faibles et l‚Äô√©quipe commerciale peut s‚Äôessouffler.";
        } else {
          msg =
            "‚ÑπÔ∏è Configuration interm√©diaire : ajustez votre coef pour viser la Zone 2 si vous souhaitez optimiser √† la fois marge et comp√©titivit√©.";
        }

        txt.innerHTML = msg;
      }

      /* ---- Sauvegardes ---- */

      function getAllConfigs() {
        return JSON.parse(localStorage.getItem("coefConfigs") || "{}");
      }

      function updateConfigList() {
        const configs = getAllConfigs();
        const select = document.getElementById("configList");
        select.innerHTML = `<option value="">‚Äî Configurations ‚Äî</option>`;
        for (const name in configs) {
          select.innerHTML += `<option value="${name}">${name}</option>`;
        }
      }

      function saveConfiguration() {
        const name = document.getElementById("configName").value.trim();
        if (!name) {
          alert("Nom obligatoire.");
          return;
        }

        const configs = getAllConfigs();

        configs[name] = {
          prix: document.getElementById("prixPublic").value,
          remiseAvant: document.getElementById("remiseAvant").value,
          coefAvant: document.getElementById("coefAvant").value,
          remiseApres: document.getElementById("remiseApres").value,
          coefApres: document.getElementById("coefApres").value,
        };

        localStorage.setItem("coefConfigs", JSON.stringify(configs));
        updateConfigList();
        alert("Configuration sauvegard√©e ‚úî");
      }

      function loadConfiguration() {
        const select = document.getElementById("configList");
        const name = select.value;
        if (!name) return;

        const cfg = getAllConfigs()[name];
        if (!cfg) return;

        document.getElementById("prixPublic").value = cfg.prix;
        document.getElementById("remiseAvant").value = cfg.remiseAvant;
        document.getElementById("coefAvant").value = cfg.coefAvant;
        document.getElementById("remiseApres").value = cfg.remiseApres;
        document.getElementById("coefApres").value = cfg.coefApres;

        updateAll();
        updateCompetitivite();
      }

      function deleteConfiguration() {
        const select = document.getElementById("configList");
        const name = select.value;
        if (!name) return;

        const configs = getAllConfigs();
        delete configs[name];
        localStorage.setItem("coefConfigs", JSON.stringify(configs));

        updateConfigList();
      }

      /* INIT */
      updateConfigList();
      updateAll();
      updateCompetitivite();
    </script>
  </body>
</html>
